{% extends "base.html" %}

{% block title %}Admin Console{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <h1 class="h3 mb-3">Admin Console</h1>
        <p class="text-muted">Use the tooling below to manage demo content while developing locally.</p>

        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <h2 class="h5">Seed Questions</h2>
                <p class="mb-3">
                    Trigger the question seeding script from the browser. Ensure the admin token matches the
                    <code>DEV_ADMIN_TOKEN</code> environment variable (default shown below).
                </p>
                <form id="seed-form" class="row gy-2 gx-3 align-items-center" onsubmit="return false;">
                    <div class="col-sm-8">
                        <label class="form-label" for="admin-token">Admin Token</label>
                        <input type="text" id="admin-token" class="form-control" value="{{ dev_token }}" autocomplete="off">
                    </div>
                    <div class="col-sm-4 d-flex align-items-end">
                        <button class="btn btn-primary w-100" type="button" id="seed-btn">Run Seed</button>
                    </div>
                </form>
                <div class="mt-3" id="seed-status" role="status" aria-live="polite"></div>
            </div>
        </div>

        <div class="alert alert-info" role="alert">
            The admin routes are intended for local development only. Secure them properly before deploying to production.
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function () {
    const seedBtn = document.getElementById('seed-btn');
    const adminTokenInput = document.getElementById('admin-token');
    const statusBox = document.getElementById('seed-status');

    if (!seedBtn || !adminTokenInput || !statusBox) {
        return;
    }

    const renderStatus = (type, message) => {
        statusBox.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    };

    seedBtn.addEventListener('click', async () => {
        renderStatus('secondary', 'Running seed...');
        seedBtn.disabled = true;
        try {
            const response = await fetch('/admin/seed', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Token': adminTokenInput.value.trim(),
                },
            });

            if (!response.ok) {
                const data = await response.json().catch(() => ({}));
                const errorMessage = data.detail || `Seed failed with status ${response.status}`;
                renderStatus('danger', errorMessage);
                return;
            }

            const result = await response.json();
            renderStatus('success', result.message || 'Seed completed successfully.');
        } catch (error) {
            renderStatus('danger', 'Unexpected error while running seed. Check the console for details.');
            console.error(error);
        } finally {
            seedBtn.disabled = false;
        }
    });
})();
</script>
{% endblock %}
